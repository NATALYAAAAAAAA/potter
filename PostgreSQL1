-- Установим расширение pg_cron
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- Создаем функцию логирования изменений по трем полям
CREATE OR REPLACE FUNCTION log_user_changes()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        INSERT INTO users_audit (user_id, changed_by, field_changed, old_value, new_value)
        VALUES (NEW.id, current_user, 'USER_CREATED', NULL, 
                CONCAT('name=', NEW.name, ', email=', NEW.email, ', role=', NEW.role));
       ELSIF (TG_OP = 'UPDATE') THEN
        IF OLD.name IS DISTINCT FROM NEW.name THEN
            INSERT INTO users_audit (user_id, changed_by, field_changed, old_value, new_value)
            VALUES (NEW.id, current_user, 'name', OLD.name, NEW.name);
        END IF;
         IF OLD.email IS DISTINCT FROM NEW.email THEN
            INSERT INTO users_audit (user_id, changed_by, field_changed, old_value, new_value)
            VALUES (NEW.id, current_user, 'email', OLD.email, NEW.email);
        END IF;
       IF OLD.role IS DISTINCT FROM NEW.role THEN
            INSERT INTO users_audit (user_id, changed_by, field_changed, old_value, new_value)
            VALUES (NEW.id, current_user, 'role', OLD.role, NEW.role);
        END IF;
    ELSIF (TG_OP = 'DELETE') THEN
        INSERT INTO users_audit (user_id, changed_by, field_changed, old_value, new_value)
        VALUES (OLD.id, current_user, 'USER_DELETED', 
                CONCAT('name=', OLD.name, ', email=', OLD.email, ', role=', OLD.role), NULL);
    END IF;
RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- Создаем trigger на таблицу users.
DROP TRIGGER IF EXISTS users_audit_trigger ON users;
CREATE TRIGGER users_audit_trigger
    AFTER INSERT OR UPDATE OR DELETE ON users
    FOR EACH ROW
    EXECUTE FUNCTION log_user_changes();

-- Создаем функцию, которая будет доставать только свежие данные
CREATE OR REPLACE FUNCTION export_yesterdays_audit_to_csv()
RETURNS TEXT AS $$
DECLARE
    export_date DATE;
    file_path TEXT;
    file_name TEXT;
    export_result TEXT;
BEGIN
    export_date := CURRENT_DATE - INTERVAL '1 day';
    file_name := 'users_audit_export_' || TO_CHAR(export_date, 'YYYYMMDD') || '.csv';
    file_path := '/tmp/' || file_name;
    EXECUTE format('
        COPY (
            SELECT 
                ua.id,
                ua.user_id,
                u.name as user_name,
                ua.changed_at,
                ua.changed_by,
                ua.field_changed,
                ua.old_value,
                ua.new_value
            FROM users_audit ua
            LEFT JOIN users u ON ua.user_id = u.id
            WHERE DATE(ua.changed_at) = %L
            ORDER BY ua.changed_at
        ) TO %L WITH CSV HEADER DELIMITER '',''',
        export_date,
        file_path
    );
    export_result := 'Файл создан: ' || file_path;
    RETURN export_result;
EXCEPTION WHEN OTHERS THEN
    RETURN 'Ошибка: ' || SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- Установка планировщик pg_cron на 3:00 ночи
SELECT cron.unschedule('daily_audit_export');
SELECT cron.schedule(
    'daily_audit_export',     
    '0 3 * * *',             
    'SELECT export_yesterdays_audit_to_csv();
